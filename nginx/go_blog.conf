# ==================== 限流配置 ====================
# 全局限流：保护服务器总承载能力（所有请求加起来）
limit_req_zone $binary_remote_addr zone=global_limit:10m rate=10000r/s;

# 限流日志级别
limit_req_log_level warn;
# 限流返回状态码
limit_req_status 429;
# ==================== 限流配置结束 ====================

server {
    listen 80;
    server_name hsk423.cn www.hsk423.cn;
    return 301 https://www.hsk423.cn$request_uri;
}

server { 
    listen 443 ssl; 
    server_name hsk423.cn;  # 仅匹配非 www 的域名
    ssl_certificate /etc/nginx/ssl/certificate.pem; # 证书公钥
    ssl_certificate_key /etc/nginx/ssl/private.key; # 证书私钥
    return 301 https://www.hsk423.cn$request_uri;  # 强制跳转到 www.your_domain
}

server {
    gzip on;
    gzip_vary on;
    gzip_disable "MSIE [1-6]\.";
    gzip_static on;
    gzip_min_length 256;
    gzip_buffers 32 8k;
    gzip_http_version 1.1;
    gzip_comp_level 5;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml application/javascript application/x-javascript application/xml application/xml+rss application/emacscript application/json image/svg+xml;

    listen 443 ssl;
    server_name www.hsk423.cn; # 多个域名用空格分开 
    ssl_certificate /etc/nginx/ssl/certificate.pem; # 证书公钥
    ssl_certificate_key /etc/nginx/ssl/private.key; # 证书私钥
    ssl_session_timeout 5m; 
    ssl_session_cache shared:MozSSL:10m;  # 设置会话缓存以提高性能 
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;  # 配置加密算法 
    ssl_protocols TLSv1.2 TLSv1.3;  # 配置加密协议 
    ssl_prefer_server_ciphers on;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always; #可选配置，开启HSTS 
    add_header X-Frame-Options DENY; # 可选配置，防止点击劫持 
    add_header X-Content-Type-Options nosniff; # 可选配置，防止MIME类型嗅探 
    add_header X-XSS-Protection "1; mode=block"; # 可选配置，防止XSS攻击

    # 流式响应特殊配置
    location /api/ai-chat/message/stream {
        # 禁用代理缓冲，确保流式数据实时传输
        proxy_buffering off;
        
        # 禁用请求缓冲
        proxy_request_buffering off;
        
        # 设置较长的超时时间
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 保持连接
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # 设置必要的头部
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 禁用gzip压缩，避免影响流式数据
        proxy_set_header Accept-Encoding "";
        
        # 代理到后端服务（容器间通信）
        proxy_pass http://server-blog:8081/api/ai-chat/message/stream;
    }

    location /api/ {
        # 只应用全局限流（基础设施保护）
        limit_req zone=global_limit burst=1000 nodelay;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # 代理到后端服务（容器间通信）
        proxy_pass http://server-blog:8081/api/;
    }

    # 静态文件代理到前端容器
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://web-blog:80;
    }

    location /image {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://web-blog:80;
    }

    location /emoji {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://web-blog:80;
    }

    location /uploads/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # 代理到后端服务的uploads目录
        proxy_pass http://server-blog:8081/uploads/;
    }
}

# SSO认证服务配置
server {
    listen 80;
    server_name sso.hsk423.cn;
    return 301 https://sso.hsk423.cn$request_uri;
}

server {
    gzip on;
    gzip_vary on;
    gzip_disable "MSIE [1-6]\.";
    gzip_static on;
    gzip_min_length 256;
    gzip_buffers 32 8k;
    gzip_http_version 1.1;
    gzip_comp_level 5;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml application/javascript application/x-javascript application/xml application/xml+rss application/emacscript application/json image/svg+xml;

    listen 443 ssl;
    server_name sso.hsk423.cn;
    ssl_certificate /etc/nginx/ssl/certificate.pem; # 复用证书
    ssl_certificate_key /etc/nginx/ssl/private.key; # 复用证书
    ssl_session_timeout 5m; 
    ssl_session_cache shared:MozSSL:10m;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # API代理到认证后端服务
    location /api/ {
        # 只应用全局限流（基础设施保护）
        limit_req zone=global_limit burst=1000 nodelay;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # 代理到认证后端服务（容器间通信）
        proxy_pass http://server-auth:8001/api/;
    }

    # 静态文件代理到认证前端容器
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://web-auth:80;
    }
}

# MCP Context 服务配置
server {
    listen 80;
    server_name mcp.hsk423.cn;
    return 301 https://mcp.hsk423.cn$request_uri;
}

server {
    # 允许请求头中包含下划线（用于自定义头如 MCP-API-KEY）
    underscores_in_headers on;
    
    gzip on;
    gzip_vary on;
    gzip_disable "MSIE [1-6]\.";
    gzip_static on;
    gzip_min_length 256;
    gzip_buffers 32 8k;
    gzip_http_version 1.1;
    gzip_comp_level 5;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml application/javascript application/x-javascript application/xml application/xml+rss application/emacscript application/json image/svg+xml;

    listen 443 ssl;
    server_name mcp.hsk423.cn;
    ssl_certificate /etc/nginx/ssl/certificate.pem;
    ssl_certificate_key /etc/nginx/ssl/private.key;
    ssl_session_timeout 5m;
    ssl_session_cache shared:MozSSL:10m;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # SSE 流式响应特殊配置（文档上传进度）
    location /api/v1/document/upload {
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Accept-Encoding "";
        proxy_pass http://server-mcp:8090/api/v1/document/upload;
    }

    # API 代理到后端服务
    location /api/ {
        limit_req zone=global_limit burst=1000 nodelay;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://server-mcp:8090/api/;
    }

    # MCP 端点代理
    location /mcp {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 转发自定义头部（将 MCP-API-KEY 转换为 MCP_API_KEY）
        proxy_set_header MCP_API_KEY $http_mcp_api_key;
        
        proxy_pass http://server-mcp:8090/mcp;
    }

    # 静态文件代理到前端容器
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://web-mcp:80;
    }
}

